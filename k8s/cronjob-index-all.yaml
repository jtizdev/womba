apiVersion: batch/v1
kind: CronJob
metadata:
  name: womba-index-all
  namespace: womba
  labels:
    app: womba
    component: index-all
    schedule: weekly
spec:
  # Schedule: Every Saturday at 3:00 AM UTC
  # Format: minute hour day-of-month month day-of-week
  # 0 = Sunday, 6 = Saturday
  schedule: "0 3 * * 6"
  
  # Keep last 3 successful jobs for debugging
  successfulJobsHistoryLimit: 3
  # Keep last 3 failed jobs for troubleshooting
  failedJobsHistoryLimit: 3
  
  # Don't start new job if previous one is still running
  concurrencyPolicy: Forbid
  
  # Timeout for job (30 minutes should be enough for index-all)
  startingDeadlineSeconds: 3600
  
  jobTemplate:
    spec:
      # Active deadline: kill job after 1 hour if still running
      activeDeadlineSeconds: 3600
      
      # Backoff limit: retry up to 2 times on failure
      backoffLimit: 2
      
      template:
        metadata:
          labels:
            app: womba
            component: index-all
            job-type: scheduled
        spec:
          serviceAccountName: default
          restartPolicy: OnFailure
          
          containers:
          - name: womba-index-all
            # Use curl to call API endpoint
            image: curlimages/curl:latest
            imagePullPolicy: IfNotPresent
            
            # Call index-all API endpoint
            command: ["/bin/sh", "-c"]
            args:
              - |
                set -e
                echo "=========================================="
                echo "üöÄ WOMBA INDEX-ALL SCHEDULED JOB"
                echo "=========================================="
                echo "‚è∞ Started at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                echo "=========================================="
                echo ""
                
                # Get project key from config or use default
                PROJECT_KEY="${PROJECT_KEY:-PLAT}"
                SERVICE_URL="${WOMBA_SERVICE_URL:-http://womba-server.womba.svc.cluster.local:8000}"
                
                echo "üì¶ Project: $PROJECT_KEY"
                echo "üåê Service: $SERVICE_URL"
                echo ""
                
                # Call index-all API endpoint
                echo "üîÑ Calling: POST /api/v1/rag/index/all?project_key=${PROJECT_KEY}&force=true"
                curl -f -X POST "${SERVICE_URL}/api/v1/rag/index/all?project_key=${PROJECT_KEY}&force=true" \
                  -H "Content-Type: application/json" \
                  --max-time 1800 \
                  -w "\n\nHTTP Status: %{http_code}\n"
                
                echo ""
                echo "=========================================="
                echo "‚úÖ INDEX-ALL COMPLETE"
                echo "‚è∞ Finished at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
                echo "=========================================="
            
            env:
            - name: PROJECT_KEY
              valueFrom:
                configMapKeyRef:
                  name: womba-config
                  key: project_key
                  optional: true
            - name: WOMBA_SERVICE_URL
              value: "http://womba-server.womba.svc.cluster.local:8000"
            
            resources:
              requests:
                memory: "64Mi"
                cpu: "50m"
              limits:
                memory: "256Mi"
                cpu: "200m"
